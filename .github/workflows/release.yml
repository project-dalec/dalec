name: Release

concurrency:
  group: release-${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.*'

permissions:
  contents: read

jobs:
  tagList:
    runs-on: ubuntu-latest
    outputs:
      tags: ${{ steps.tags.outputs.OUTPUT_TAGS }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Get image tag list
        id: tags
        run: |
          set -eux -o pipefail

          # Remove leading "v" from tag name
          TRIMMED_REF_NAME="${REF_NAME#v}"

          # Creates a comma separated list of tags
          # - <major>.<minor>
          # - <major>.<minor>.<patch>
          OUTPUT_TAGS="${TRIMMED_REF_NAME%.*},${TRIMMED_REF_NAME}"

          # Check if this tag is the latest release by fetching the latest release and comparing the tag to the tag being built.
          LATEST_TAG="$(gh release view --json tagName -q .tagName)"
          if [ "$REF_NAME" = "$LATEST_TAG" ]; then
            OUTPUT_TAGS="latest,${OUTPUT_TAGS}"
          fi

          echo "OUTPUT_TAGS=${OUTPUT_TAGS}" >> "$GITHUB_OUTPUT" && cat "$GITHUB_OUTPUT"
        env:
          REF_NAME: ${{ github.ref_name }}
          GH_TOKEN: ${{ github.token }}
        shell: bash

  build:
    permissions:
      contents: read
      packages: write

    needs: tagList
    uses: ./.github/workflows/frontend-image.yml
    with:
      tag: ${{needs.tagList.outputs.tags}}
